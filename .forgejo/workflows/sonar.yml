name: SonarQube Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    container:
      image: sonarsource/sonar-scanner-cli:latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        run: |
          sonar-scanner \
            -Dsonar.host.url=http://homelab-sonarqube:9000 \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.projectKey=wt-sim-project \
            -Dsonar.projectName="WT Sim Project" \
            -Dsonar.sources=.

  # ---------------------------------------------------------------------------
  # LLM Code Review (on PRs only) - posts comment directly on PR
  # ---------------------------------------------------------------------------
  ai-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr.diff
          echo "Diff size: $(wc -c < /tmp/pr.diff) bytes"
          echo "First 500 chars of diff:"
          head -c 500 /tmp/pr.diff

      - name: AI Code Review
        env:
          FORGEJO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Use Python for proper JSON handling (diff has special chars that break shell JSON)
          python3 << 'PYEOF'
          import json
          import urllib.request
          import os

          # Read diff
          with open('/tmp/pr.diff', 'r', errors='replace') as f:
              diff = f.read()

          diff_size = len(diff)
          print(f"Diff size: {diff_size} bytes")

          if diff_size > 50000:
              review = f"‚ö†Ô∏è Diff too large for AI review ({diff_size} bytes). Please review manually."
          else:
              # Truncate diff for LLM
              diff = diff[:30000]
              print("Calling Ollama...")

              prompt = f"""Review this git diff for bugs, security issues, and improvements. Be concise and actionable. Focus on real problems, not style nits.

          Diff:
          {diff}"""

              payload = json.dumps({
                  "model": "qwen2.5-coder:7b",
                  "prompt": prompt,
                  "stream": False,
                  "options": {"temperature": 0.1, "num_predict": 1024}
              }).encode()

              try:
                  req = urllib.request.Request(
                      "http://host.docker.internal:11434/api/generate",
                      data=payload,
                      headers={"Content-Type": "application/json"}
                  )
                  with urllib.request.urlopen(req, timeout=180) as resp:
                      result = json.load(resp)
                      review = result.get("response", "No response from model")
                      print(f"Got review: {len(review)} chars")
              except Exception as e:
                  review = f"‚ö†Ô∏è Error calling Ollama: {e}"
                  print(review)

          # Post comment to PR
          comment_body = f"## ü§ñ AI Code Review\n\n{review}"
          comment_payload = json.dumps({"body": comment_body}).encode()

          pr_number = os.environ["PR_NUMBER"]
          repo = os.environ["REPO"]
          token = os.environ["FORGEJO_TOKEN"]

          req = urllib.request.Request(
              f"http://forgejo:3000/api/v1/repos/{repo}/issues/{pr_number}/comments",
              data=comment_payload,
              headers={
                  "Content-Type": "application/json",
                  "Authorization": f"token {token}"
              }
          )

          try:
              with urllib.request.urlopen(req, timeout=30) as resp:
                  print(f"Comment posted to PR #{pr_number}")
          except Exception as e:
              print(f"Failed to post comment: {e}")
          PYEOF
